<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Etch a Schech</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:100,200,300,400,500,600,700" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.css">
  <link rel="stylesheet" href="css/animate.css">
  <link rel="stylesheet" href="css/main.css">
  
</head>
<body>
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.js"></script>
  <!-- Custom JavaScript -->
  <script src="js/animate.js"></script>
  <script src="js/custom.js"></script>
  <script>
    $('.carousel').carousel({
     interval: 2000
   })

    window.onscroll = function() {myFunction()};

    var header = document.getElementById("myHeader");
    var sticky = header.offsetTop;

    function myFunction() {
      if (window.pageYOffset > sticky) {
        header.classList.add("sticky");
      } else {
        header.classList.remove("sticky");
      }
    }
  </script>
  <script>
    $(document).on('click', '[data-toggle="lightbox"]', function(event) {
      event.preventDefault();
      $(this).ekkoLightbox();
    });
  </script>

  <!-- Navigation -->
    <!--- For every new page, be sure to add the file.html and then include
          a link to it here as well so it can be accessed. 
          Make sure that the href is just to the page in the hierarchy and
          not absolutely addressed so it can be used on the olin server. -->
          <nav id="myHeader" class="header navbar navbar-expand-lg navbar-dark">
            <div class="container">
              <a class="navbar-brand" href="index.html"><img src="images/Etcha.png" alt="logo" height="80"></a>
              <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                  <li class="nav-item">
                    <a class="nav-link" href="index.html">Home
                      <span class="sr-only">(current)</span>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="system.html">Architecture</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="mechanical.html">Mechanical</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="electrical.html">Electrical</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="software.html">Software</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="process.html">Process</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="budget.html">Budget</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="team.html">Team</a>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
          
          <header class="banner">                                                     
            <div class="gradient"></div>                                              
            <div class="container">                                                 
              <div class="row">                                                     
                <div class="col-sm-12 heading">                                     
                  <h1 data-aos="Fade-right" data-aos-delay="300"> Software Subsystem</h1>
                  <h5 data-aos="Fade-left" data-aos-delay="300"> Software Pipelines for Clean Trace Lines </h5>
                </div>                                                              
              </div>                                                                
            </div>                                                                  
          </div>                                                                    
        </header>  

        <div class="row" data-aos="fade-up" data-aos-duration="300">



          <!-- Centered text container. -->
          <div class="container">
            <div class="row" data-aos="fade-up" data-aos-duration="300">
              <div class="col-md-12">
                <br>
                <h3 class="heading1"><center><a href="https://github.com/anushadatar/pcb_printer">Overall Framework</a></center></h3>
                <br>
                <div class="inner-content">
                 <p> The etch as schech computing framework requires two distinct systems - a computer capable of process PCB designs and creating and processing the approprirate toolpaths and a real-time microcontroller to actually deliver these commands to the motors. We chose to create a system capable of running on Ubuntu and debian machines (and integrated directly with a Raspberry Pi minicomputer) to handle more expensive computation and an Arduino Uno V3 as our real-time microcontroller. </p>
                 <p> With these two systems, we can create a seammless workflow for the user - they transfer the file they hope to etch onto a workpiece to the computer, interact with a very simple Graphical User Interface (GUI) to confirm their selection, and watch the operation progress and complete. </p>
                 <center><img src="images/software-architecture.png" alt="Software Architecture Overview Diagram" height="400"></center>
               </div>
               <br>
               <h3><center><a href="https://github.com/anushadatar/pcb_printer/tree/master/firmware">Firmware Architecture</a></center></h3>
               <br>
               <p>To safely and systematically handle the etching sequence, we implemented a state machine on the Arduino 
                that is composed of three main states: Idle, Operational, and Error. The Idle state is made up of 
                three additional substates: Idle Entry, Idle, and Idle Exit. Then, the Idle substate is made up of four sub-substates 
                which are: Free, X, Y, and Z. The Operational state is made up of two substates: Etching and Etching Exit. 
                The Error state currently consists of only one state: Limit Switch Error. The flows between all these 
              different states in best illustrated through the image below.</p>
              <center>
                <figure>
                  <img class="image" src="images/Arduino_State_Machine.png" alt="firmware_state_machine">
                  <figcaption>The code architecture used in Arduino for real time control.</figcaption>
                </figure>
              </center>
              <p>During the Idle entry state, Arduino sets up its proper general purpose input output to drive the different stepper
                motor and automatically transition to Idle state. Within the Idle state, a user is free to choose between jogging a specific axis and
                manually turning the lead screw for a particular axis. The amount by which to move a specific axis is determined by reading values from a quadrature encoder on the front panel of the enclosure for the system. Pushing down on the encoder triggers a switch between the axes, or a transition between the substates of the Idle substate.
              </p>
              <p>When a milling job is ready to be executed, the Rasberry Pi sends a start signal that triggers an interrupt on the Arduino so that
                it enters the state Idle Exit. In Idle Exit, the Arduino enables all of the stepper motors and begins to spin the DC motor on the z axis.
              </p>
              <p>Following the Idle Exit state, the system begins etching and enters the operational state. In this case, the Arduino actively listens on the serial port and runs a gcode parser. It holds the spindle speed constant throughout while the Arduino controls the stepper motors for each of the three axes according to the results of parsing the gcode sent to the Arduino from the Raspberry Pi. The program terminates when the Arduino receives an ending signal from the Raspberry pi along with the final line of gcode to interpret and execute. Once the last command has been executed, the Arduino will return to the Idle state.
              </p>
              <h3><center><a href="https://github.com/anushadatar/pcb_printer/tree/master/software">Software Architecture</a></center></h3>
              The software framework that runs on the computer (Windows PC, Ubuntu environment, Raspberry Pi, etc.) handles the user interaction necessary to obtain a file to etch the contents of, creating toolpaths from that file, formatting the toolpaths, and communicating each line of execution to the real-time microcontroller. While our fully integrated product uses the Raspberry Pi as its computing platform, our code is also compatible with most Linux machines capable of running bash and python. 
              <br> 
              <p>The user interface contains a tkinter-based graphical user interface (GUI) that can be used to either select the file from the computer's file system or choose the most recent file on a USB flash drive plugged into the machine. The GUI then triggers a shell script which executes the software pipeline.</p>
              <center><img src="images/gui_menu.png" alt="GUI Screenshot" height="80"></center>
              <p> The software framework then leverages FlatCAM to create toolpaths based on the tool diameter associated with the filetype of the chosen file. It displays the image to trace and the intended toolpath before continuing. </p> 
              <p> Due to the fact that FlatCAM's raw output has inconsistencies that complicate gcode parsing firmware, the program <i>gcode_format.py</i> processes the output gcode file and arranges its contents. Then, <i>gcode_stream.py</i> takes in the formatted gcode and tries to send the gcode commands line by line to the Arduino to execute. The Arduino and the gcoder streamer use a custom handshaking protocol to make sure that a new command will only be dispatched in the wake of last command's successful execution. 
              </p>
              <br>
              <h3> Dependencies </h3>
              Both the firmware and software systems leverage a large number of existing frameworks and libraries. Those frameworks (and associated requirements for functionality) include:
              <ul>
                <li> <a href="https://www.arduino.cc/en/Main/Software"> Arduino </a> </li>
                <ul>
                  <li><a href="https://github.com/laurb9/StepperDriver">StepperDriver</a>: Arduino library for A4988, DRV8825, DRV8834, DRV8880 and generic two-pin (DIR/STEP) stepper motor drivers </li>
                  <li><a href="https://www.pjrc.com/teensy/td_libs_Encoder.html">Encoder Library</a>: Encoder counts pulses from quadrature encoded signals, which are commonly available from rotary knobs, motor r shaft sensors and other position sensors. </li>
                </ul>
                <li> <a href="https://www.python.org/downloads/release/python-371/"> Python 3 </a></li>
                <ul>
                  <li><a href="https://pythonhosted.org/pyserial/">pySerial</a></li><br>
                  <li><a href="https://docs.python.org/3/library/optparse.html">optparse</a></li><br>
                  <li><a href="https://docs.python.org/3/library/time.html">time</a></li><br>
                  <li><a href="https://docs.python.org/3/library/sys.html">sys</a></li><br>
                  <li><a href="https://docs.python.org/3/library/os.html">os</a></li>
                </ul>
                <li> <a href="https://bitbucket.org/jpcgt/flatcam/downloads/">Flatcam</a> </li>
                <ul>
                  <li><a href="https://www.riverbankcomputing.com/software/sip/download">SIP</a></li><br>
                  <li><a href="https://www.riverbankcomputing.com/software/pyqt/download">PyQt4</a></li>
                </ul>


              </body>
              </html>